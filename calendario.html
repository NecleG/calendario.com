<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio RH - Responsabilidades Fiscais 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .blur-background {
            filter: blur(5px);
            transition: filter 0.3s ease;
        }
        
        .login-modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.7);
        }
        
        .login-form {
            animation: loginSlideIn 0.5s ease-out;
        }
        
        @keyframes loginSlideIn {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-50px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            transform: scale(1.05);
        }
        .fiscal-event {
            font-size: 0.7rem;
            line-height: 1.1;
        }
        .event-fgts { background-color: #ef4444; }
        .event-inss { background-color: #3b82f6; }
        .event-irrf { background-color: #10b981; }
        .event-pis { background-color: #f59e0b; }
        .event-rais { background-color: #8b5cf6; }
        .event-dirf { background-color: #ec4899; }
        .event-folha { background-color: #06b6d4; }
        .event-holiday { background-color: #dc2626; }
        .holiday-day { background-color: #fef2f2; border-color: #dc2626; }
        
        .calendar-fade-out {
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .calendar-fade-in {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease;
        }
        
        .year-bounce {
            animation: yearBounce 0.5s ease;
        }
        
        @keyframes yearBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .month-card {
            transition: all 0.3s ease;
        }
        
        .month-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .month-header {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .modal-fade-in {
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .modal-fade-out {
            animation: modalFadeOut 0.3s ease-in;
        }
        
        @keyframes modalFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes modalFadeOut {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
        }
        
        .modal-content {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-yellow-400 to-yellow-500 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 login-modal flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 login-form">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üîê</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Calend√°rio RH</h2>
                <p class="text-gray-600">Fa√ßa login para acessar seu calend√°rio</p>
            </div>
            
            <div id="loginForm">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                    <input type="text" id="loginUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite seu usu√°rio">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Digite sua senha">
                </div>
                <button onclick="attemptLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold mb-4 transition-all duration-300">
                    üöÄ Entrar
                </button>
                <button onclick="showRegisterForm()" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-semibold transition-all duration-300">
                    ‚ûï Criar Nova Conta
                </button>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
                    <input type="text" id="registerUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Escolha um nome de usu√°rio">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="registerPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Crie uma senha">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                    <input type="password" id="confirmPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Confirme sua senha">
                </div>
                <button onclick="attemptRegister()" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-semibold mb-4 transition-all duration-300">
                    ‚úÖ Criar Conta
                </button>
                <button onclick="showLoginForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-all duration-300">
                    ‚Üê Voltar ao Login
                </button>
            </div>
            
            <div id="loginMessage" class="mt-4 text-center text-sm hidden"></div>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-8 blur-background">
        <!-- Logo Space -->
        <div class="text-center mb-8">
            <img src="https://imgur.com/CVsV7Ty.png" alt="Logo da Loja" class="mx-auto max-h-24 object-contain">
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="syncData()" id="syncButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                    ‚òÅÔ∏è Sincronizar
                </button>
                <h1 class="text-4xl font-bold text-gray-800">üìÖ Calend√°rio RH</h1>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                    üö™ Sair
                </button>
            </div>
            <div id="userWelcome" class="text-lg text-gray-700 mb-2"></div>
            <div id="storageStatus" class="text-sm text-gray-600 mt-2"></div>
            <div id="deviceInfo" class="text-xs text-gray-500 mt-1"></div>
        </div>

        <!-- Daily Notifications -->
        <div id="dailyNotifications" class="mb-8 hidden">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-400">
                <div class="flex items-center mb-4">
                    <div class="text-3xl mr-3">üîî</div>
                    <div>
                        <h3 class="text-xl font-bold">Lembretes de Hoje</h3>
                        <p id="todayDate" class="text-blue-100"></p>
                    </div>
                </div>
                <div id="todayItems" class="space-y-3"></div>
                <button onclick="dismissNotifications()" class="mt-4 bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                    ‚úÖ Entendi, dispensar
                </button>
            </div>
        </div>

        <!-- Year Navigation -->
        <div class="flex justify-center items-center mb-8 space-x-4">
            <button id="prevYearBtn" onclick="changeYear(-1)" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105">
                ‚Üê <span id="prevYear">2023</span>
            </button>
            <h2 id="currentYear" class="text-3xl font-bold text-gray-800 transition-all duration-500 transform">2024</h2>
            <button id="nextYearBtn" onclick="changeYear(1)" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105">
                <span id="nextYear">2025</span> ‚Üí
            </button>
        </div>

        <!-- Legend -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Legenda das Obriga√ß√µes</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                    <span class="text-sm">FGTS</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                    <span class="text-sm">INSS</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                    <span class="text-sm">IRRF</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                    <span class="text-sm">PIS</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-purple-500 rounded"></div>
                    <span class="text-sm">RAIS</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-pink-500 rounded"></div>
                    <span class="text-sm">DIRF</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-cyan-500 rounded"></div>
                    <span class="text-sm">Folha</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-red-600 rounded"></div>
                    <span class="text-sm">Feriados</span>
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendarGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Months will be generated here -->
        </div>

        <!-- Event Details Modal -->
        <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md mx-4 modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                <div id="modalContent" class="text-gray-600"></div>
                <button onclick="closeModal()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg w-full">
                    Fechar
                </button>
            </div>
        </div>

        <!-- Notes Modal -->
        <div id="notesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md mx-4 w-full modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="notesModalTitle" class="text-xl font-bold text-gray-800">üìù Observa√ß√µes</h3>
                    <button onclick="closeNotesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adicionar observa√ß√£o:</label>
                    <textarea id="noteInput" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="4" placeholder="Digite sua observa√ß√£o aqui..."></textarea>
                </div>
                <div class="flex space-x-3">
                    <button onclick="saveNote()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold">
                        üíæ Salvar
                    </button>
                    <button onclick="deleteNote()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                        üóëÔ∏è Excluir
                    </button>
                    <button onclick="closeNotesModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold">
                        Cancelar
                    </button>
                </div>
                <div id="existingNote" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                    <h4 class="font-semibold text-gray-800 mb-2">Observa√ß√£o atual:</h4>
                    <p id="existingNoteText" class="text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentYear = 2024;
        let currentNoteDate = '';
        let currentUser = null;
        
        // Login system functions
        function loadUsers() {
            try {
                const stored = localStorage.getItem('calendarUsers');
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                return {};
            }
        }
        
        function saveUsers(users) {
            try {
                localStorage.setItem('calendarUsers', JSON.stringify(users));
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar usu√°rios:', error);
                return false;
            }
        }
        
        async function checkCurrentUser() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                await showMainContent();
                return true;
            }
            return false;
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginMessage').classList.add('hidden');
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginMessage').classList.add('hidden');
        }
        
        function showMessage(message, isError = false) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.textContent = message;
            messageDiv.className = `mt-4 text-center text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
            messageDiv.classList.remove('hidden');
        }
        
        async function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showMessage('Por favor, preencha todos os campos!', true);
                return;
            }
            
            const users = loadUsers();
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMessage('Login realizado com sucesso! üéâ Carregando dados...');
                
                await showMainContent();
                
                setTimeout(() => {
                    document.getElementById('loginModal').style.display = 'none';
                }, 1000);
            } else {
                showMessage('Usu√°rio ou senha incorretos!', true);
            }
        }
        
        function attemptRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!username || !password || !confirmPassword) {
                showMessage('Por favor, preencha todos os campos!', true);
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('As senhas n√£o coincidem!', true);
                return;
            }
            
            if (username.length < 3) {
                showMessage('O nome de usu√°rio deve ter pelo menos 3 caracteres!', true);
                return;
            }
            
            if (password.length < 4) {
                showMessage('A senha deve ter pelo menos 4 caracteres!', true);
                return;
            }
            
            const users = loadUsers();
            
            if (users[username]) {
                showMessage('Este usu√°rio j√° existe! Escolha outro nome.', true);
                return;
            }
            
            users[username] = {
                password: password,
                createdAt: new Date().toISOString()
            };
            
            if (saveUsers(users)) {
                showMessage('Conta criada com sucesso! Fa√ßa login agora. ‚úÖ');
                setTimeout(() => {
                    showLoginForm();
                    document.getElementById('loginUsername').value = username;
                }, 1500);
            } else {
                showMessage('Erro ao criar conta. Tente novamente.', true);
            }
        }
        
        async function showMainContent() {
            document.getElementById('mainContent').classList.remove('blur-background');
            document.getElementById('userWelcome').textContent = `üëã Bem-vindo, ${currentUser}!`;
            
            // Load user-specific notes with cloud sync
            await loadUserNotes();
            
            // Initialize calendar for this user
            generateCalendar();
            updateStorageStatus();
            cleanupOldDismissals();
            checkDailyNotifications();
            
            // Auto-sync every 5 minutes
            setInterval(async () => {
                if (currentUser) {
                    await syncData();
                }
            }, 5 * 60 * 1000);
        }
        
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                userNotes = {};
                
                // Show login modal again
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('mainContent').classList.add('blur-background');
                
                // Clear forms
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showLoginForm();
            }
        }
        
        // Cloud-based storage system with cross-device sync
        const CLOUD_API_BASE = 'https://api.jsonbin.io/v3/b';
        const CLOUD_API_KEY = '$2a$10$9vKnVkwX8Y2tGfRq5Hl6O.rX3zM4wP7sJ9nF2kL8vB6cA1dE5gH9i'; // Demo key
        
        async function loadUserNotes() {
            if (!currentUser) return {};
            
            // Show loading indicator
            updateStorageStatus('üîÑ Sincronizando dados...');
            
            try {
                // First try to load from cloud
                const cloudData = await loadFromCloud();
                if (cloudData && Object.keys(cloudData).length > 0) {
                    console.log('‚òÅÔ∏è Dados carregados da nuvem para', currentUser + ':', Object.keys(cloudData).length, 'notas');
                    userNotes = cloudData;
                    // Also save locally as backup
                    saveToLocal(cloudData);
                    return cloudData;
                }
                
                // If cloud fails, try local storage
                const localData = loadFromLocal();
                if (localData && Object.keys(localData).length > 0) {
                    console.log('üíæ Dados carregados localmente para', currentUser + ':', Object.keys(localData).length, 'notas');
                    userNotes = localData;
                    // Try to sync to cloud in background
                    saveToCloud(localData, false);
                    return localData;
                }
                
                console.log('üìù Nenhuma observa√ß√£o encontrada para', currentUser + ', iniciando novo sistema');
                userNotes = {};
                return {};
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar observa√ß√µes:', error);
                // Fallback to local storage
                const localData = loadFromLocal();
                userNotes = localData || {};
                return userNotes;
            }
        }
        
        function loadFromLocal() {
            try {
                const stored = localStorage.getItem(`calendarNotes_${currentUser}`);
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados locais:', error);
                return {};
            }
        }
        
        function saveToLocal(notes) {
            try {
                const notesString = JSON.stringify(notes);
                localStorage.setItem(`calendarNotes_${currentUser}`, notesString);
                localStorage.setItem(`calendarNotes_${currentUser}_backup`, notesString);
                localStorage.setItem(`calendarNotes_${currentUser}_lastSaved`, new Date().toISOString());
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar localmente:', error);
                return false;
            }
        }
        
        async function loadFromCloud() {
            try {
                const binId = getUserBinId();
                if (!binId) return null;
                
                const response = await fetch(`${CLOUD_API_BASE}/${binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': CLOUD_API_KEY,
                        'X-Bin-Meta': 'false'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.notes || {};
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar da nuvem:', error);
                return null;
            }
        }
        
        async function saveToCloud(notes, showStatus = true) {
            try {
                if (showStatus) updateStorageStatus('‚òÅÔ∏è Salvando na nuvem...');
                
                let binId = getUserBinId();
                const payload = {
                    user: currentUser,
                    notes: notes,
                    lastModified: new Date().toISOString(),
                    device: getDeviceInfo()
                };
                
                let response;
                if (binId) {
                    // Update existing bin
                    response = await fetch(`${CLOUD_API_BASE}/${binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': CLOUD_API_KEY
                        },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new bin
                    response = await fetch(`${CLOUD_API_BASE}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': CLOUD_API_KEY,
                            'X-Bin-Name': `calendar-${currentUser}`,
                            'X-Bin-Private': 'true'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        binId = result.metadata.id;
                        setUserBinId(binId);
                    }
                }
                
                if (response.ok) {
                    console.log('‚òÅÔ∏è Dados salvos na nuvem com sucesso para', currentUser);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar na nuvem:', error);
                if (showStatus) updateStorageStatus('‚ö†Ô∏è Erro na sincroniza√ß√£o - dados salvos localmente');
                return false;
            }
        }
        
        function getUserBinId() {
            return localStorage.getItem(`cloudBinId_${currentUser}`);
        }
        
        function setUserBinId(binId) {
            localStorage.setItem(`cloudBinId_${currentUser}`, binId);
        }
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let device = 'Desktop';
            if (/Mobile|Android|iPhone|iPad/.test(ua)) {
                device = /iPhone|iPad/.test(ua) ? 'iOS' : 'Android';
            }
            return {
                type: device,
                timestamp: new Date().toISOString(),
                userAgent: ua.substring(0, 100) // Truncate for privacy
            };
        }
        
        async function saveNotes(notes) {
            if (!currentUser) return false;
            
            try {
                // Always save locally first (immediate feedback)
                const localSaved = saveToLocal(notes);
                
                // Then try to save to cloud
                const cloudSaved = await saveToCloud(notes);
                
                if (localSaved) {
                    console.log('üíæ Observa√ß√µes salvas para', currentUser + ':', Object.keys(notes).length, 'notas');
                    if (cloudSaved) {
                        updateStorageStatus(`‚òÅÔ∏è ${Object.keys(notes).length} observa√ß√£o${Object.keys(notes).length > 1 ? '√µes' : ''} sincronizada${Object.keys(notes).length > 1 ? 's' : ''} na nuvem`);
                    } else {
                        updateStorageStatus(`üíæ ${Object.keys(notes).length} observa√ß√£o${Object.keys(notes).length > 1 ? '√µes' : ''} salva${Object.keys(notes).length > 1 ? 's' : ''} localmente`);
                    }
                    return true;
                }
                return false;
            } catch (error) {
                console.error('‚ùå Erro ao salvar observa√ß√µes:', error);
                alert('Erro ao salvar observa√ß√£o. Verifique sua conex√£o com a internet.');
                return false;
            }
        }
        
        async function syncData() {
            if (!currentUser) return;
            
            updateStorageStatus('üîÑ Sincronizando...');
            
            try {
                const cloudData = await loadFromCloud();
                const localData = loadFromLocal();
                
                // Simple merge strategy: cloud data takes precedence if newer
                if (cloudData && Object.keys(cloudData).length > 0) {
                    const cloudTime = localStorage.getItem(`cloudSync_${currentUser}_lastSync`);
                    const localTime = localStorage.getItem(`calendarNotes_${currentUser}_lastSaved`);
                    
                    if (!localTime || (cloudTime && new Date(cloudTime) > new Date(localTime))) {
                        userNotes = cloudData;
                        saveToLocal(cloudData);
                        generateCalendar();
                        updateStorageStatus('‚òÅÔ∏è Dados sincronizados da nuvem');
                        return;
                    }
                }
                
                // If local data is newer or cloud is empty, upload local data
                if (localData && Object.keys(localData).length > 0) {
                    await saveToCloud(localData);
                    updateStorageStatus('‚òÅÔ∏è Dados locais enviados para a nuvem');
                } else {
                    updateStorageStatus('‚úÖ Dados sincronizados');
                }
                
                localStorage.setItem(`cloudSync_${currentUser}_lastSync`, new Date().toISOString());
                
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                updateStorageStatus('‚ö†Ô∏è Erro na sincroniza√ß√£o');
            }
        }
        
        let userNotes = {};
        
        const months = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        const fiscalEvents = {
            // FGTS - dia 7 de cada m√™s
            'fgts': { day: 7, type: 'event-fgts', title: 'FGTS', description: 'Recolhimento do FGTS referente ao m√™s anterior' },
            // INSS - dia 20 de cada m√™s
            'inss': { day: 20, type: 'event-inss', title: 'INSS', description: 'Recolhimento da contribui√ß√£o previdenci√°ria' },
            // IRRF - √∫ltimo dia √∫til do m√™s
            'irrf': { day: 30, type: 'event-irrf', title: 'IRRF', description: 'Recolhimento do Imposto de Renda Retido na Fonte' },
            // PIS - dia 20 de cada m√™s
            'pis': { day: 20, type: 'event-pis', title: 'PIS', description: 'Recolhimento do PIS sobre folha de pagamento' },
            // Folha de pagamento - dia 5 de cada m√™s
            'folha': { day: 5, type: 'event-folha', title: 'Folha', description: 'Fechamento da folha de pagamento' }
        };

        const specialEvents = {
            // Fiscal obligations
            '2024-01-31': { type: 'event-dirf', title: 'DIRF', description: 'Entrega da Declara√ß√£o do Imposto de Renda Retido na Fonte' },
            '2024-03-31': { type: 'event-rais', title: 'RAIS', description: 'Entrega da Rela√ß√£o Anual de Informa√ß√µes Sociais' },
            '2024-04-30': { type: 'event-irrf', title: 'IRRF Anual', description: 'Declara√ß√£o anual do Imposto de Renda' },
            '2024-07-31': { type: 'event-rais', title: 'CAGED', description: 'Cadastro Geral de Empregados e Desempregados' }
        };

        const nationalHolidays = {
            // 2022 holidays
            '2022-01-01': { type: 'event-holiday', title: 'Confraterniza√ß√£o Universal', description: 'Feriado Nacional' },
            '2022-02-28': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Segunda-feira)' },
            '2022-03-01': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Ter√ßa-feira)' },
            '2022-04-15': { type: 'event-holiday', title: 'Sexta-feira Santa', description: 'Feriado Nacional' },
            '2022-04-21': { type: 'event-holiday', title: 'Tiradentes', description: 'Feriado Nacional' },
            '2022-04-23': { type: 'event-holiday', title: 'Dia de S√£o Jorge', description: 'Feriado Regional' },
            '2022-05-01': { type: 'event-holiday', title: 'Dia do Trabalhador', description: 'Feriado Nacional' },
            '2022-09-07': { type: 'event-holiday', title: 'Independ√™ncia do Brasil', description: 'Feriado Nacional' },
            '2022-10-07': { type: 'event-holiday', title: 'Nossa Senhora do Ros√°rio', description: 'Feriado Regional' },
            '2022-10-12': { type: 'event-holiday', title: 'Nossa Senhora Aparecida', description: 'Feriado Nacional' },
            '2022-11-02': { type: 'event-holiday', title: 'Finados', description: 'Feriado Nacional' },
            '2022-11-15': { type: 'event-holiday', title: 'Proclama√ß√£o da Rep√∫blica', description: 'Feriado Nacional' },
            '2022-11-20': { type: 'event-holiday', title: 'Dia da Consci√™ncia Negra', description: 'Feriado Nacional' },
            '2022-11-25': { type: 'event-holiday', title: 'Anivers√°rio de Quatis', description: 'Anivers√°rio da cidade de Quatis' },
            '2022-12-25': { type: 'event-holiday', title: 'Natal', description: 'Feriado Nacional' },
            
            // 2023 holidays
            '2023-01-01': { type: 'event-holiday', title: 'Confraterniza√ß√£o Universal', description: 'Feriado Nacional' },
            '2023-02-20': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Segunda-feira)' },
            '2023-02-21': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Ter√ßa-feira)' },
            '2023-04-07': { type: 'event-holiday', title: 'Sexta-feira Santa', description: 'Feriado Nacional' },
            '2023-04-21': { type: 'event-holiday', title: 'Tiradentes', description: 'Feriado Nacional' },
            '2023-04-23': { type: 'event-holiday', title: 'Dia de S√£o Jorge', description: 'Feriado Regional' },
            '2023-05-01': { type: 'event-holiday', title: 'Dia do Trabalhador', description: 'Feriado Nacional' },
            '2023-09-07': { type: 'event-holiday', title: 'Independ√™ncia do Brasil', description: 'Feriado Nacional' },
            '2023-10-07': { type: 'event-holiday', title: 'Nossa Senhora do Ros√°rio', description: 'Feriado Regional' },
            '2023-10-12': { type: 'event-holiday', title: 'Nossa Senhora Aparecida', description: 'Feriado Nacional' },
            '2023-11-02': { type: 'event-holiday', title: 'Finados', description: 'Feriado Nacional' },
            '2023-11-15': { type: 'event-holiday', title: 'Proclama√ß√£o da Rep√∫blica', description: 'Feriado Nacional' },
            '2023-11-20': { type: 'event-holiday', title: 'Dia da Consci√™ncia Negra', description: 'Feriado Nacional' },
            '2023-11-25': { type: 'event-holiday', title: 'Anivers√°rio de Quatis', description: 'Anivers√°rio da cidade de Quatis' },
            '2023-12-25': { type: 'event-holiday', title: 'Natal', description: 'Feriado Nacional' },
            
            // 2024 holidays
            '2024-01-01': { type: 'event-holiday', title: 'Confraterniza√ß√£o Universal', description: 'Feriado Nacional' },
            '2024-02-12': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Segunda-feira)' },
            '2024-02-13': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Ter√ßa-feira)' },
            '2024-03-29': { type: 'event-holiday', title: 'Sexta-feira Santa', description: 'Feriado Nacional' },
            '2024-04-21': { type: 'event-holiday', title: 'Tiradentes', description: 'Feriado Nacional' },
            '2024-04-23': { type: 'event-holiday', title: 'Dia de S√£o Jorge', description: 'Feriado Regional' },
            '2024-05-01': { type: 'event-holiday', title: 'Dia do Trabalhador', description: 'Feriado Nacional' },
            '2024-09-07': { type: 'event-holiday', title: 'Independ√™ncia do Brasil', description: 'Feriado Nacional' },
            '2024-10-07': { type: 'event-holiday', title: 'Nossa Senhora do Ros√°rio', description: 'Feriado Regional' },
            '2024-10-12': { type: 'event-holiday', title: 'Nossa Senhora Aparecida', description: 'Feriado Nacional' },
            '2024-11-02': { type: 'event-holiday', title: 'Finados', description: 'Feriado Nacional' },
            '2024-11-15': { type: 'event-holiday', title: 'Proclama√ß√£o da Rep√∫blica', description: 'Feriado Nacional' },
            '2024-11-20': { type: 'event-holiday', title: 'Dia da Consci√™ncia Negra', description: 'Feriado Nacional' },
            '2024-11-25': { type: 'event-holiday', title: 'Anivers√°rio de Quatis', description: 'Anivers√°rio da cidade de Quatis' },
            '2024-12-25': { type: 'event-holiday', title: 'Natal', description: 'Feriado Nacional' },
            
            // 2025 holidays
            '2025-01-01': { type: 'event-holiday', title: 'Confraterniza√ß√£o Universal', description: 'Feriado Nacional' },
            '2025-03-03': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Segunda-feira)' },
            '2025-03-04': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Ter√ßa-feira)' },
            '2025-04-18': { type: 'event-holiday', title: 'Sexta-feira Santa', description: 'Feriado Nacional' },
            '2025-04-21': { type: 'event-holiday', title: 'Tiradentes', description: 'Feriado Nacional' },
            '2025-04-23': { type: 'event-holiday', title: 'Dia de S√£o Jorge', description: 'Feriado Regional' },
            '2025-05-01': { type: 'event-holiday', title: 'Dia do Trabalhador', description: 'Feriado Nacional' },
            '2025-09-07': { type: 'event-holiday', title: 'Independ√™ncia do Brasil', description: 'Feriado Nacional' },
            '2025-10-07': { type: 'event-holiday', title: 'Nossa Senhora do Ros√°rio', description: 'Feriado Regional' },
            '2025-10-12': { type: 'event-holiday', title: 'Nossa Senhora Aparecida', description: 'Feriado Nacional' },
            '2025-11-02': { type: 'event-holiday', title: 'Finados', description: 'Feriado Nacional' },
            '2025-11-15': { type: 'event-holiday', title: 'Proclama√ß√£o da Rep√∫blica', description: 'Feriado Nacional' },
            '2025-11-20': { type: 'event-holiday', title: 'Dia da Consci√™ncia Negra', description: 'Feriado Nacional' },
            '2025-11-25': { type: 'event-holiday', title: 'Anivers√°rio de Quatis', description: 'Anivers√°rio da cidade de Quatis' },
            '2025-12-25': { type: 'event-holiday', title: 'Natal', description: 'Feriado Nacional' },
            
            // 2026 holidays
            '2026-01-01': { type: 'event-holiday', title: 'Confraterniza√ß√£o Universal', description: 'Feriado Nacional' },
            '2026-02-16': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Segunda-feira)' },
            '2026-02-17': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Ter√ßa-feira)' },
            '2026-04-03': { type: 'event-holiday', title: 'Sexta-feira Santa', description: 'Feriado Nacional' },
            '2026-04-21': { type: 'event-holiday', title: 'Tiradentes', description: 'Feriado Nacional' },
            '2026-04-23': { type: 'event-holiday', title: 'Dia de S√£o Jorge', description: 'Feriado Regional' },
            '2026-05-01': { type: 'event-holiday', title: 'Dia do Trabalhador', description: 'Feriado Nacional' },
            '2026-09-07': { type: 'event-holiday', title: 'Independ√™ncia do Brasil', description: 'Feriado Nacional' },
            '2026-10-07': { type: 'event-holiday', title: 'Nossa Senhora do Ros√°rio', description: 'Feriado Regional' },
            '2026-10-12': { type: 'event-holiday', title: 'Nossa Senhora Aparecida', description: 'Feriado Nacional' },
            '2026-11-02': { type: 'event-holiday', title: 'Finados', description: 'Feriado Nacional' },
            '2026-11-15': { type: 'event-holiday', title: 'Proclama√ß√£o da Rep√∫blica', description: 'Feriado Nacional' },
            '2026-11-20': { type: 'event-holiday', title: 'Dia da Consci√™ncia Negra', description: 'Feriado Nacional' },
            '2026-11-25': { type: 'event-holiday', title: 'Anivers√°rio de Quatis', description: 'Anivers√°rio da cidade de Quatis' },
            '2026-12-25': { type: 'event-holiday', title: 'Natal', description: 'Feriado Nacional' },
            
            // 2027 holidays
            '2027-01-01': { type: 'event-holiday', title: 'Confraterniza√ß√£o Universal', description: 'Feriado Nacional' },
            '2027-02-08': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Segunda-feira)' },
            '2027-02-09': { type: 'event-holiday', title: 'Carnaval', description: 'Feriado Nacional (Ter√ßa-feira)' },
            '2027-03-26': { type: 'event-holiday', title: 'Sexta-feira Santa', description: 'Feriado Nacional' },
            '2027-04-21': { type: 'event-holiday', title: 'Tiradentes', description: 'Feriado Nacional' },
            '2027-04-23': { type: 'event-holiday', title: 'Dia de S√£o Jorge', description: 'Feriado Regional' },
            '2027-05-01': { type: 'event-holiday', title: 'Dia do Trabalhador', description: 'Feriado Nacional' },
            '2027-09-07': { type: 'event-holiday', title: 'Independ√™ncia do Brasil', description: 'Feriado Nacional' },
            '2027-10-07': { type: 'event-holiday', title: 'Nossa Senhora do Ros√°rio', description: 'Feriado Regional' },
            '2027-10-12': { type: 'event-holiday', title: 'Nossa Senhora Aparecida', description: 'Feriado Nacional' },
            '2027-11-02': { type: 'event-holiday', title: 'Finados', description: 'Feriado Nacional' },
            '2027-11-15': { type: 'event-holiday', title: 'Proclama√ß√£o da Rep√∫blica', description: 'Feriado Nacional' },
            '2027-11-20': { type: 'event-holiday', title: 'Dia da Consci√™ncia Negra', description: 'Feriado Nacional' },
            '2027-11-25': { type: 'event-holiday', title: 'Anivers√°rio de Quatis', description: 'Anivers√°rio da cidade de Quatis' },
            '2027-12-25': { type: 'event-holiday', title: 'Natal', description: 'Feriado Nacional' }
        };

        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'bg-white rounded-xl shadow-lg overflow-hidden month-card';
                
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                const firstDay = new Date(currentYear, month, 1).getDay();
                
                let monthHTML = `
                    <div class="month-header text-white p-4">
                        <h3 class="text-xl font-bold">${months[month]} ${currentYear}</h3>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">Dom</div>
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">Seg</div>
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">Ter</div>
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">Qua</div>
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">Qui</div>
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">Sex</div>
                            <div class="text-center text-xs font-semibold text-gray-500 p-1">S√°b</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                `;

                // Empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    monthHTML += '<div class="h-12"></div>';
                }

                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = getEventsForDay(day, month + 1);
                    const isToday = isCurrentDate(day, month);
                    
                    let dayClass = 'calendar-day h-12 border rounded cursor-pointer flex flex-col items-center justify-center text-xs relative';
                    const isHoliday = nationalHolidays[dateStr];
                    
                    if (isToday) {
                        dayClass += ' bg-blue-100 border-blue-500 font-bold';
                    } else if (isHoliday) {
                        dayClass += ' holiday-day font-semibold text-red-700';
                    } else {
                        dayClass += ' hover:bg-gray-50';
                    }

                    const hasNote = userNotes[dateStr];
                    const noteIndicator = hasNote ? '<div class="absolute top-0 right-0 w-2 h-2 bg-orange-500 rounded-full"></div>' : '';
                    
                    monthHTML += `
                        <div class="${dayClass}" onclick="showDayOptions('${dateStr}', ${day}, '${months[month]}')">
                            <span class="font-semibold">${day}</span>
                            ${events.map(event => `<div class="w-2 h-1 ${event.type} rounded-full mt-0.5"></div>`).join('')}
                            ${noteIndicator}
                        </div>
                    `;
                }

                monthHTML += '</div></div>';
                monthDiv.innerHTML = monthHTML;
                calendarGrid.appendChild(monthDiv);
            }
        }

        function getEventsForDay(day, month) {
            const events = [];
            const dateStr = `${currentYear}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // Check special events
            if (specialEvents[dateStr]) {
                events.push(specialEvents[dateStr]);
            }
            
            // Check national holidays
            if (nationalHolidays[dateStr]) {
                events.push(nationalHolidays[dateStr]);
            }
            
            // Check recurring fiscal events
            Object.values(fiscalEvents).forEach(event => {
                if (event.day === day) {
                    events.push(event);
                }
            });
            
            return events;
        }

        function isCurrentDate(day, month) {
            const today = new Date();
            return today.getDate() === day && 
                   today.getMonth() === month && 
                   today.getFullYear() === currentYear;
        }

        function showDayOptions(dateStr, day, monthName) {
            const events = getEventsForDay(day, parseInt(dateStr.split('-')[1]));
            const hasNote = userNotes[dateStr];
            
            // If there are events, show them first
            if (events.length > 0) {
                showEvents(dateStr, day, monthName, events);
                return;
            }
            
            // If no events, go directly to notes
            openNotesModal(dateStr, day, monthName);
        }

        function showEvents(dateStr, day, monthName, events) {
            const modal = document.getElementById('eventModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalTitle = document.getElementById('modalTitle');
            const modalContentDiv = document.getElementById('modalContent');
            
            modalTitle.textContent = `${day} de ${monthName} ${currentYear}`;
            
            let content = '<div class="space-y-3">';
            events.forEach(event => {
                content += `
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h4 class="font-semibold text-gray-800">${event.title}</h4>
                        <p class="text-sm text-gray-600">${event.description}</p>
                    </div>
                `;
            });
            
            // Add note button
            content += `
                <div class="mt-4 pt-4 border-t">
                    <button onclick="closeModal(); openNotesModal('${dateStr}', ${day}, '${monthName}')" 
                            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold">
                        üìù ${userNotes[dateStr] ? 'Ver/Editar Observa√ß√£o' : 'Adicionar Observa√ß√£o'}
                    </button>
                </div>
            `;
            
            content += '</div>';
            
            modalContentDiv.innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalContent.classList.add('modal-fade-in');
        }

        function closeModal() {
            const modal = document.getElementById('eventModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.classList.remove('modal-fade-in');
            modalContent.classList.add('modal-fade-out');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalContent.classList.remove('modal-fade-out');
            }, 300);
        }

        function openNotesModal(dateStr, day, monthName) {
            currentNoteDate = dateStr;
            const modal = document.getElementById('notesModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalTitle = document.getElementById('notesModalTitle');
            const noteInput = document.getElementById('noteInput');
            const existingNote = document.getElementById('existingNote');
            const existingNoteText = document.getElementById('existingNoteText');
            
            modalTitle.textContent = `üìù Observa√ß√µes - ${day} de ${monthName} ${currentYear}`;
            
            // Load existing note if any
            if (userNotes[dateStr]) {
                noteInput.value = userNotes[dateStr];
                existingNoteText.textContent = userNotes[dateStr];
                existingNote.classList.remove('hidden');
            } else {
                noteInput.value = '';
                existingNote.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalContent.classList.add('modal-fade-in');
            
            setTimeout(() => {
                noteInput.focus();
            }, 100);
        }

        function closeNotesModal() {
            const modal = document.getElementById('notesModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.classList.remove('modal-fade-in');
            modalContent.classList.add('modal-fade-out');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalContent.classList.remove('modal-fade-out');
            }, 300);
        }

        function saveNote() {
            const noteInput = document.getElementById('noteInput');
            const noteText = noteInput.value.trim();
            
            if (noteText) {
                userNotes[currentNoteDate] = noteText;
                
                // Use enhanced save function
                if (saveNotes(userNotes)) {
                    // Show success message
                    const originalText = document.querySelector('button[onclick="saveNote()"]').innerHTML;
                    document.querySelector('button[onclick="saveNote()"]').innerHTML = '‚úÖ Salvo!';
                    document.querySelector('button[onclick="saveNote()"]').classList.add('bg-green-500', 'hover:bg-green-600');
                    document.querySelector('button[onclick="saveNote()"]').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    
                    console.log('‚úÖ Observa√ß√£o salva para:', currentNoteDate, '- Conte√∫do:', noteText);
                    
                    setTimeout(() => {
                        generateCalendar(); // Refresh to show note indicator
                        updateStorageStatus(); // Update status display
                        checkDailyNotifications(); // Check if we need to show notifications
                        closeNotesModal();
                        
                        // Reset button
                        setTimeout(() => {
                            const saveBtn = document.querySelector('button[onclick="saveNote()"]');
                            if (saveBtn) {
                                saveBtn.innerHTML = originalText;
                                saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                                saveBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                            }
                        }, 100);
                    }, 1000);
                } else {
                    // Save failed
                    document.querySelector('button[onclick="saveNote()"]').innerHTML = '‚ùå Erro ao salvar';
                    document.querySelector('button[onclick="saveNote()"]').classList.add('bg-red-500');
                    setTimeout(() => {
                        document.querySelector('button[onclick="saveNote()"]').innerHTML = 'üíæ Salvar';
                        document.querySelector('button[onclick="saveNote()"]').classList.remove('bg-red-500');
                    }, 2000);
                }
            } else {
                // Show error message
                const noteInput = document.getElementById('noteInput');
                noteInput.classList.add('border-red-500', 'bg-red-50');
                noteInput.placeholder = 'Por favor, digite uma observa√ß√£o...';
                
                setTimeout(() => {
                    noteInput.classList.remove('border-red-500', 'bg-red-50');
                    noteInput.placeholder = 'Digite sua observa√ß√£o aqui...';
                }, 2000);
            }
        }

        function deleteNote() {
            const deleteBtn = document.querySelector('button[onclick="deleteNote()"]');
            const originalText = deleteBtn.innerHTML;
            const noteInput = document.getElementById('noteInput');
            const existingNote = document.getElementById('existingNote');
            
            // Check if there's any note to delete
            const hasStoredNote = userNotes[currentNoteDate];
            const hasInputText = noteInput.value.trim();
            
            if (hasStoredNote || hasInputText) {
                if (confirm('Tem certeza que deseja excluir esta observa√ß√£o?')) {
                    // Always delete from storage regardless
                    if (userNotes[currentNoteDate]) {
                        delete userNotes[currentNoteDate];
                        // Use enhanced save function
                        if (!saveNotes(userNotes)) {
                            alert('Erro ao excluir observa√ß√£o. Tente novamente.');
                            return;
                        }
                        console.log('‚úÖ Observa√ß√£o exclu√≠da com sucesso para:', currentNoteDate);
                    }
                    
                    // Clear the input field
                    noteInput.value = '';
                    
                    // Hide existing note display
                    existingNote.classList.add('hidden');
                    
                    // Show success message
                    deleteBtn.innerHTML = '‚úÖ Exclu√≠do!';
                    deleteBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    deleteBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    
                    setTimeout(() => {
                        // Refresh calendar to remove orange indicator
                        generateCalendar();
                        updateStorageStatus(); // Update status display
                        closeNotesModal();
                        
                        // Reset button after modal closes
                        setTimeout(() => {
                            if (deleteBtn) {
                                deleteBtn.innerHTML = originalText;
                                deleteBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                                deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                            }
                        }, 100);
                    }, 1500);
                }
            } else {
                // Show message when there's no note to delete
                deleteBtn.innerHTML = '‚ùå Nenhuma observa√ß√£o';
                deleteBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                deleteBtn.classList.add('bg-gray-400');
                
                setTimeout(() => {
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.classList.remove('bg-gray-400');
                    deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                }, 2000);
            }
        }

        function changeYear(direction) {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentYearElement = document.getElementById('currentYear');
            const prevYearElement = document.getElementById('prevYear');
            const nextYearElement = document.getElementById('nextYear');
            
            // Add fade out animation to calendar
            calendarGrid.classList.add('calendar-fade-out');
            
            // Add bounce animation to year
            currentYearElement.classList.add('year-bounce');
            
            setTimeout(() => {
                currentYear += direction;
                currentYearElement.textContent = currentYear;
                prevYearElement.textContent = currentYear - 1;
                nextYearElement.textContent = currentYear + 1;
                
                generateCalendar();
                
                // Add fade in animation to calendar
                calendarGrid.classList.remove('calendar-fade-out');
                calendarGrid.classList.add('calendar-fade-in');
                
                setTimeout(() => {
                    currentYearElement.classList.remove('year-bounce');
                    calendarGrid.classList.remove('calendar-fade-in');
                }, 300);
            }, 300);
        }

        // Update storage status display with cloud sync info
        function updateStorageStatus(customMessage = null) {
            const statusDiv = document.getElementById('storageStatus');
            const deviceDiv = document.getElementById('deviceInfo');
            
            if (customMessage) {
                statusDiv.textContent = customMessage;
                statusDiv.className = 'text-sm text-blue-600 mt-2';
                return;
            }
            
            const noteCount = Object.keys(userNotes).length;
            const lastSaved = localStorage.getItem(`calendarNotes_${currentUser}_lastSaved`);
            const lastSync = localStorage.getItem(`cloudSync_${currentUser}_lastSync`);
            
            if (noteCount > 0) {
                let statusText = `üíæ ${noteCount} observa√ß√£o${noteCount > 1 ? '√µes' : ''} salva${noteCount > 1 ? 's' : ''}`;
                
                if (lastSync) {
                    const syncDate = new Date(lastSync);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - syncDate) / (1000 * 60));
                    
                    if (diffMinutes < 1) {
                        statusText += ' ‚Ä¢ ‚òÅÔ∏è Sincronizado agora';
                    } else if (diffMinutes < 60) {
                        statusText += ` ‚Ä¢ ‚òÅÔ∏è Sincronizado h√° ${diffMinutes} min`;
                    } else {
                        const diffHours = Math.floor(diffMinutes / 60);
                        statusText += ` ‚Ä¢ ‚òÅÔ∏è Sincronizado h√° ${diffHours}h`;
                    }
                } else if (lastSaved) {
                    statusText += ' ‚Ä¢ üíæ Apenas local';
                }
                
                statusDiv.textContent = statusText;
                statusDiv.className = 'text-sm text-green-600 mt-2';
            } else {
                statusDiv.textContent = 'üìù Nenhuma observa√ß√£o salva ainda';
                statusDiv.className = 'text-sm text-gray-500 mt-2';
            }
            
            // Show device info
            const deviceInfo = getDeviceInfo();
            deviceDiv.textContent = `üì± Dispositivo: ${deviceInfo.type} ‚Ä¢ Acesso multi-dispositivo ativo`;
            deviceDiv.className = 'text-xs text-gray-500 mt-1';
        }

        // Daily notifications system
        function checkDailyNotifications() {
            if (!currentUser) return;
            
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const dismissedKey = `dismissed_${currentUser}_${todayStr}`;
            
            // Check if already dismissed today
            if (localStorage.getItem(dismissedKey)) {
                console.log('üìÖ Notifica√ß√µes j√° foram dispensadas hoje para', currentUser);
                return;
            }
            
            const todayItems = [];
            
            // Check for user notes
            if (userNotes[todayStr]) {
                todayItems.push({
                    type: 'note',
                    icon: 'üìù',
                    title: 'Sua Observa√ß√£o',
                    description: userNotes[todayStr],
                    priority: 'high'
                });
            }
            
            // Check for fiscal events
            const events = getEventsForDay(today.getDate(), today.getMonth() + 1);
            events.forEach(event => {
                let icon = 'üìã';
                let priority = 'medium';
                
                if (event.type === 'event-holiday') {
                    icon = 'üéâ';
                    priority = 'low';
                } else if (event.type === 'event-fgts' || event.type === 'event-inss') {
                    icon = 'üí∞';
                    priority = 'high';
                } else if (event.type === 'event-folha') {
                    icon = 'üìä';
                    priority = 'high';
                }
                
                todayItems.push({
                    type: 'event',
                    icon: icon,
                    title: event.title,
                    description: event.description,
                    priority: priority
                });
            });
            
            // Show notifications if there are items
            if (todayItems.length > 0) {
                showDailyNotifications(todayItems, today);
            }
        }
        
        function showDailyNotifications(items, date) {
            const notificationDiv = document.getElementById('dailyNotifications');
            const todayDateDiv = document.getElementById('todayDate');
            const todayItemsDiv = document.getElementById('todayItems');
            
            // Format date
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            todayDateDiv.textContent = date.toLocaleDateString('pt-BR', options);
            
            // Sort items by priority (high, medium, low)
            const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
            items.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            
            // Generate items HTML
            let itemsHTML = '';
            items.forEach(item => {
                let bgColor = 'bg-white bg-opacity-10';
                let borderColor = 'border-white border-opacity-30';
                
                if (item.priority === 'high') {
                    bgColor = 'bg-red-500 bg-opacity-20';
                    borderColor = 'border-red-300';
                } else if (item.priority === 'medium') {
                    bgColor = 'bg-yellow-500 bg-opacity-20';
                    borderColor = 'border-yellow-300';
                }
                
                itemsHTML += `
                    <div class="${bgColor} ${borderColor} border-l-4 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">${item.icon}</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${item.title}</h4>
                                <p class="text-blue-100 mt-1">${item.description}</p>
                                ${item.priority === 'high' ? '<span class="inline-block mt-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">üö® URGENTE</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            todayItemsDiv.innerHTML = itemsHTML;
            
            // Show notification with animation
            notificationDiv.classList.remove('hidden');
            setTimeout(() => {
                notificationDiv.style.opacity = '0';
                notificationDiv.style.transform = 'translateY(-20px)';
                notificationDiv.style.transition = 'all 0.5s ease';
                notificationDiv.style.opacity = '1';
                notificationDiv.style.transform = 'translateY(0)';
            }, 100);
            
            console.log('üîî Mostrando', items.length, 'notifica√ß√£o(√µes) para hoje');
        }
        
        function dismissNotifications() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const dismissedKey = `dismissed_${currentUser}_${todayStr}`;
            
            // Mark as dismissed for today
            localStorage.setItem(dismissedKey, 'true');
            
            // Hide notification with animation
            const notificationDiv = document.getElementById('dailyNotifications');
            notificationDiv.style.transition = 'all 0.5s ease';
            notificationDiv.style.opacity = '0';
            notificationDiv.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                notificationDiv.classList.add('hidden');
                notificationDiv.style.opacity = '';
                notificationDiv.style.transform = '';
                notificationDiv.style.transition = '';
            }, 500);
            
            console.log('‚úÖ Notifica√ß√µes dispensadas para hoje');
        }
        
        // Clean up old dismissed notifications (keep only last 30 days)
        function cleanupOldDismissals() {
            if (!currentUser) return;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`dismissed_${currentUser}_`)) {
                    const dateStr = key.replace(`dismissed_${currentUser}_`, '');
                    const dismissedDate = new Date(dateStr);
                    if (dismissedDate < thirtyDaysAgo) {
                        localStorage.removeItem(key);
                        i--; // Adjust index since we removed an item
                    }
                }
            }
        }

        // Initialize login system
        (async () => {
            const hasUser = await checkCurrentUser();
            if (!hasUser) {
                // Show login modal if no user is logged in
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('mainContent').classList.add('blur-background');
            }
        })();
        
        // Add keyboard support for login forms
        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                attemptLogin();
            }
        });
        
        document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                attemptRegister();
            }
        });

        // Close modal when clicking outside
        document.getElementById('eventModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('notesModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNotesModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a6ccdc178b940e',t:'MTc1NDQwMjIxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
